# 第2阶段：乱序执行引擎（OOO）实现

本阶段目标是在现有的五级流水线基础上，升级为乱序执行架构，核心机制包括寄存器重命名、保留站（Reservation Stations）、乱序发射、有序提交。

---

## 🎯 阶段目标

- [ ] 理解 Tomasulo 算法核心结构
- [ ] 实现寄存器重命名逻辑（映射表）
- [ ] 实现保留站（Reservation Stations）队列
- [ ] 引入 ROB（Reorder Buffer）管理提交顺序
- [ ] 加入乱序发射/执行、有序提交逻辑
- [ ] 验证分支错误回滚机制（flush ROB + RS）

---

## 本阶段输出成果

-实现带 ROB、RS、重命名逻辑的乱序执行引擎
-能执行算术/访存/跳转指令（控制转移暂不预测）
-每次提交都有 trace log 可分析执行顺序
-至少 2 个测试程序，验证乱序执行功能

---

## ⏱ 建议时间安排（约7~10天）

| 时间 | 任务 |
|------|------|
| Day 1 | 阅读 Tomasulo 算法和典型实现 |
| Day 2 | 搭建 ROB、RS 数据结构 |
| Day 3 | 实现寄存器重命名 + 分发逻辑 |
| Day 4 | 支持多个功能单元的调度执行 |
| Day 5 | 实现执行完成 → 写回 RS 和 ROB |
| Day 6 | 加入提交与 commit 逻辑 |
| Day 7-10 | 调试、写测试程序、记录日志 |

---

## 🧩 模块框图示意

  ┌────────┐
  │ Rename │◄────────┐
  └────────┘         │
       │             │ 物理寄存器映射
       ▼             ▼
┌─────────────┐ ┌─────────────┐
│ Reservation │◄───▶│ Functional │
│ Stations │ │ Units │
└─────────────┘ └─────────────┘
│ ▲
▼ │
┌─────────────┐ ┌─────────────┐
│ ROB │◄────┤ Write Result│
└─────────────┘ └─────────────┘
▼
Commit 逻辑


---

## 📚 重点理解概念

- **Tomasulo 算法**
  - Issue：发射指令 → RS / ROB
  - Execute：当操作数 ready → 开始执行
  - Write Result：将结果广播回 RS/ROB
  - Commit：按照顺序提交

- **ROB（Reorder Buffer）**
  - 跟踪指令是否完成，支持回滚
  - 管理有序提交

- **RS（Reservation Stations）**
  - 存储正在等待执行的指令及其操作数状态

- **寄存器重命名表**
  - 用于消除 WAW/RAW 冒险，分配临时的“物理寄存器”索引

---

## 📚 推荐资料

- [Tomasulo算法演示动画](https://www.youtube.com/watch?v=Db4I2MrG6TY)
- [《计算机体系结构：量化研究方法》第3章](https://book.douban.com/subject/27069552/)
- [RVCoreP 的源码解读](https://github.com/AnonymousX1024/RVCoreP)

---

## 🧪 测试建议

- [ ] 连续写入同一个寄存器，检查是否能正确重命名、执行
- [ ] 多条算术指令 + 数据依赖链：验证发射顺序与执行乱序
- [ ] 加入 flush/回滚测试（模拟分支错误后撤销）

---

## 📘 日志建议模板（每次学习记录）

```markdown
### Day 3 - 实现保留站结构

- ✅ 实现 RS 和 ROB 数据结构
- ✅ 在 Issue 阶段进行映射与重命名
- ❗ 写回环节顺序控制不准确，待修复
- 💡 明天目标：执行/完成信号广播回 RS
